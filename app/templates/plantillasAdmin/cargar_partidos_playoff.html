<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8">
<title>Cargar Partidos Playoff</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<style>
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

body {
  background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
  color: #f5f6fa;
  min-height: 100vh;
  padding: 20px 0;
}

.container {
  max-width: 1000px;
}

.header {
  text-align: center;
  margin-bottom: 40px;
  padding: 30px 0;
}

.header h1 {
  font-size: 2.5rem;
  font-weight: 700;
  color: #5dade2;
  margin-bottom: 10px;
  text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
}

.header p {
  color: #a9a9a9;
  font-size: 1rem;
}

.card {
  background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
  border: 1px solid rgba(93, 173, 226, 0.3);
  border-radius: 15px;
  padding: 35px;
  box-shadow: 0 10px 40px rgba(0,0,0,0.3);
}

.form-section {
  margin-bottom: 30px;
  padding-bottom: 30px;
  border-bottom: 1px solid rgba(93, 173, 226, 0.2);
}

.form-section:last-child {
  border-bottom: none;
  margin-bottom: 0;
  padding-bottom: 0;
}

.section-title {
  font-size: 1.1rem;
  font-weight: 600;
  color: #5dade2;
  margin-bottom: 20px;
  display: flex;
  align-items: center;
}

.section-title i {
  margin-right: 10px;
  font-size: 1.3rem;
}

.form-label {
  color: #85c1e9;
  font-weight: 600;
  font-size: 0.95rem;
  margin-bottom: 8px;
}

.form-select, 
.form-control {
  background: #1f1f1f !important;
  color: #fff !important;
  border: 2px solid #5dade2 !important;
  border-radius: 8px;
  padding: 10px 12px;
  font-size: 0.95rem;
  transition: all 0.3s ease;
}

.form-select:focus, 
.form-control:focus {
  border-color: #85c1e9 !important;
  box-shadow: 0 0 10px rgba(133, 193, 233, 0.3) !important;
  background: #252525 !important;
}

.form-select option {
  color: #000 !important;
  background: #fff !important;
}

.form-select option:checked {
  background: #5dade2 !important;
  color: #fff !important;
}

.form-select:disabled,
.form-control:disabled {
  background: #1a1a1a !important;
  border-color: #555 !important;
  color: #888 !important;
  opacity: 0.6;
}

/* Estilos para radio buttons de categor√≠a */
.categoria-group {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
  gap: 12px;
  margin-top: 10px;
}

.categoria-btn {
  position: relative;
  padding: 12px;
  text-align: center;
  background: #1f1f1f;
  border: 2px solid #5dade2;
  border-radius: 8px;
  cursor: pointer;
  transition: all 0.3s ease;
  font-weight: 500;
  color: #85c1e9;
}

.categoria-btn:hover {
  background: #252525;
  border-color: #85c1e9;
}

.categoria-btn input[type="radio"] {
  display: none;
}

.categoria-btn input[type="radio"]:checked + span {
  color: #fff;
}

.categoria-btn input[type="radio"]:checked {
  display: none;
}

.categoria-btn input[type="radio"]:checked + span::before {
  content: "‚úì ";
  color: #00ff00;
  font-weight: bold;
}

.categoria-btn:has(input[type="radio"]:checked) {
  background: linear-gradient(135deg, #5dade2 0%, #3498db 100%);
  border-color: #2980b9;
  color: #fff;
}

/* Selector de clubes */
.row {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
  gap: 20px;
  margin-top: 0 !important;
}

.col-md-6 {
  margin-bottom: 0 !important;
}

.info-box {
  background: rgba(93, 173, 226, 0.1);
  border-left: 4px solid #5dade2;
  padding: 12px;
  border-radius: 6px;
  margin-top: 10px;
  font-size: 0.9rem;
  color: #a9a9a9;
}

.info-box i {
  margin-right: 8px;
  color: #5dade2;
}

/* Botones */
.btn-primary {
  background: linear-gradient(135deg, #5dade2 0%, #3498db 100%);
  border: none;
  font-weight: 600;
  padding: 12px 30px;
  border-radius: 8px;
  transition: all 0.3s ease;
  margin-top: 20px;
  font-size: 1rem;
}

.btn-primary:hover {
  background: linear-gradient(135deg, #85c1e9 0%, #5dade2 100%);
  transform: translateY(-2px);
  box-shadow: 0 5px 20px rgba(93, 173, 226, 0.4);
}

.btn-primary:active {
  transform: translateY(0);
}

.btn-primary:disabled {
  background: #555;
  cursor: not-allowed;
  opacity: 0.6;
  transform: none;
}

/* Estados de carga */
.loading {
  display: none;
  text-align: center;
  margin-top: 15px;
}

.spinner-border {
  color: #5dade2;
}

/* Alert de validaci√≥n */
.alert-info {
  background: rgba(93, 173, 226, 0.15);
  border: 1px solid #5dade2;
  color: #85c1e9;
  border-radius: 8px;
  margin-bottom: 20px;
}

.alert-warning {
  background: rgba(255, 193, 7, 0.15);
  border: 1px solid #ffc107;
  color: #ffb74d;
  border-radius: 8px;
}
.back-link {
            text-align: center;
            display: block;
            margin-top: 20px;
            color: #bbb;
        }

        .back-link:hover {
            color: #4fc3f7;
        }

/* Responsive */
@media (max-width: 768px) {
  .header h1 {
    font-size: 1.8rem;
  }
  
  .card {
    padding: 20px;
  }
  
  .categoria-group {
    grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
  }
}
</style>
</head>

<body>
<div class="container mt-4 mb-5">
  <div class="header">
    <h1><i class="fas fa-trophy"></i> Carga de Partidos Playoff</h1>
    <p>Configura los partidos decisivos de la temporada</p>
  </div>

  <div class="card">
    <form id="formPartido">
      
      <!-- SECCI√ìN 1: TORNEO Y FASE -->
      <div class="form-section">
        <div class="section-title">
          <i class="fas fa-calendar-alt"></i> Torneo y Fase
        </div>

        <label class="form-label">Temporada</label>
          <select class="form-select" disabled>
            <option selected>{{ temporada_activa.nombre }}</option>
          </select> <br>

        <div class="mb-3">
          <label class="form-label">Selecciona el Torneo</label>
          <select id="torneo_id" class="form-select" required>
            <option value="">-- Seleccionar torneo --</option>
            {% for t in torneos %}
              <option value="{{ t.id }}">{{ t.nombre }}</option>
            {% endfor %}
          </select>
          <div class="info-box">
            <i class="fas fa-info-circle"></i> Los torneos m√°s recientes aparecen primero
          </div>
        </div>

        <div class="mb-3">
          <label class="form-label">Selecciona la Fase</label>
          <select id="fase_nombre" class="form-select" required>
            <option value="">-- Seleccionar fase --</option>
            {% for fase in fases %}
              <option value="{{ fase }}">{{ fase }}</option>
            {% endfor %}
          </select>
          <div class="info-box">
            <i class="fas fa-info-circle"></i> Cuartos de Final, Semifinal, Final, Final√≠sima
          </div>
        </div>

        <!-- TIPO DE FASE (Solo Ida o Ida y Vuelta) -->
        <div class="mb-3">
          <label class="form-label">Tipo de Enfrentamiento</label>
          <select id="tipo_fase" class="form-select" required>
            <option value="">-- Seleccionar tipo --</option>
            <option value="0">Solo Ida (1 partido)</option>
            <option value="1">Ida y Vuelta (2 partidos)</option>
          </select>
          <div class="info-box">
            <i class="fas fa-info-circle"></i> Mayores: Ida y Vuelta | Inferiores: Solo Ida (excepto Final que es Ida y Vuelta)
          </div>
        </div>

        <!-- JORNADA (IDA/VUELTA) - Condicional -->
        <div id="bloque-ida-vuelta" style="display:none;">
          <div class="mb-3">
            <label class="form-label">Selecciona el Partido</label>
            <select id="jornada" class="form-select">
              <option value="1">Ida</option>
              <option value="2">Vuelta</option>
            </select>
          </div>
        </div>
      </div>

      <!-- SECCI√ìN 2: CATEGOR√çA -->
      <div class="form-section">
        <div class="section-title">
          <i class="fas fa-layer-group"></i> Categor√≠a
        </div>

        <label class="form-label">Selecciona la Categor√≠a</label>
        <div class="categoria-group">
          {% for c in categorias %}
            <label class="categoria-btn">
              <input type="radio" name="categoria" value="{{ c|lower }}" required>
              <span>{{ c }}</span>
            </label>
          {% endfor %}
        </div>
        <div class="info-box">
          <i class="fas fa-info-circle"></i> Elige la categor√≠a para la cual cargar este partido
        </div>
      </div>

      <!-- SECCI√ìN 3: EQUIPOS -->
      <div class="form-section">
        <div class="section-title">
          <i class="fas fa-shield-alt"></i> Equipos Clasificados
        </div>

        <div class="row">
          <div class="col-md-6">
            <label class="form-label">Club Local</label>
            <select id="club_local_id" class="form-select" required>
              <option value="">-- Seleccionar club --</option>
            </select>
          </div>
          <div class="col-md-6">
            <label class="form-label">Club Visitante</label>
            <select id="club_visitante_id" class="form-select" required>
              <option value="">-- Seleccionar club --</option>
            </select>
          </div>
        </div>

        <div class="info-box" id="matchInfo" style="display:none; margin-top: 15px;">
          <i class="fas fa-exclamation-circle"></i> <span id="matchInfoText"></span>
        </div>
      </div>

      <!-- SECCI√ìN 4: FECHA Y HORA -->
      <div class="form-section">
        <div class="section-title">
          <i class="fas fa-clock"></i> Fecha y Hora (Opcional)
        </div>

        <div class="row">
          <div class="col-md-6">
            <label class="form-label">Fecha del Partido</label>
            <input type="date" id="fecha_partido" class="form-control">
          </div>
          <div class="col-md-6">
            <label class="form-label">Hora de Inicio</label>
            <input type="time" id="hora_partido" class="form-control">
          </div>
        </div>
      </div>

      <!-- BOT√ìN DE ENV√çO -->
      <div style="text-align: center;">
        <button type="button" onclick="guardarPartido()" class="btn btn-primary" id="btnGuardar">
          <i class="fas fa-save"></i> Guardar Partido
        </button>
        <div class="loading" id="loading">
          <div class="spinner-border spinner-border-sm" role="status">
            <span class="visually-hidden">Cargando...</span>
          </div>
          <p style="margin-top: 10px; color: #5dade2;">Procesando...</p>
        </div>
      </div>

    </form>
    <a href="{{ url_for('views.adminview') }}" class="back-link">‚Üê Volver al panel de administrador</a>
  </div>
</div>

<script>
const $id = id => document.getElementById(id);
const $query = sel => document.querySelector(sel);

// ========== ELEMENTOS DEL FORMULARIO ==========
const torneo = $id("torneo_id");
const fase = $id("fase_nombre");
const tipoFase = $id("tipo_fase");
const jornada = $id("jornada");
const bloqueIdaVuelta = $id("bloque-ida-vuelta");
const categoriaRadios = document.querySelectorAll('input[name="categoria"]');
const clubLocal = $id("club_local_id");
const clubVisitante = $id("club_visitante_id");
const fechaPartido = $id("fecha_partido");
const horaPartido = $id("hora_partido");
const btnGuardar = $id("btnGuardar");
const loading = $id("loading");

// Variables para almacenar clubes disponibles
let clubesDisponibles = [];

// ========== CARGAR CLUBES CLASIFICADOS ==========
async function cargarClubesClasificados() {
  const torneo_id = torneo.value;
  const fase_nombre = fase.value;
  const categoria = document.querySelector('input[name="categoria"]:checked')?.value;

  if (!torneo_id || !fase_nombre || !categoria) {
    clubLocal.innerHTML = '<option value="">-- Seleccionar club --</option>';
    clubVisitante.innerHTML = '<option value="">-- Seleccionar club --</option>';
    return;
  }

  try {
    const url = `/api/playoff/clubes_clasificados?torneo_id=${torneo_id}&nombre_fase=${encodeURIComponent(fase_nombre)}&categoria=${categoria}`;
    const res = await fetch(url);
    const data = await res.json();

    if (data.success && data.clubes) {
      clubesDisponibles = data.clubes;
      actualizarSelectsClubes();
    } else {
      clubLocal.innerHTML = '<option value="">-- Seleccionar club --</option>';
      clubVisitante.innerHTML = '<option value="">-- Seleccionar club --</option>';
    }
  } catch (err) {
    console.error("Error cargando clubes:", err);
  }
}

// ========== ACTUALIZAR SELECTS ==========
function actualizarSelectsClubes() {
  const localId = clubLocal.value;
  const visitanteId = clubVisitante.value;

  clubLocal.innerHTML = '<option value="">-- Seleccionar club --</option>';
  clubVisitante.innerHTML = '<option value="">-- Seleccionar club --</option>';

  clubesDisponibles.forEach(club => {
    const optLocal = document.createElement('option');
    optLocal.value = club.id;
    optLocal.textContent = club.nombre;
    if (String(club.id) === String(localId)) optLocal.selected = true;
    clubLocal.appendChild(optLocal);

    if (String(club.id) !== String(localId)) {
      const optVisit = document.createElement('option');
      optVisit.value = club.id;
      optVisit.textContent = club.nombre;
      if (String(club.id) === String(visitanteId)) optVisit.selected = true;
      clubVisitante.appendChild(optVisit);
    }
  });

  updateMatchInfo();
}

// ========== EVENTOS ==========
torneo.addEventListener("change", cargarClubesClasificados);
fase.addEventListener("change", cargarClubesClasificados);
categoriaRadios.forEach(radio => {
  radio.addEventListener("change", cargarClubesClasificados);
});

tipoFase.addEventListener("change", e => {
  const idaVuelta = e.target.value === "1";
  bloqueIdaVuelta.style.display = idaVuelta ? "block" : "none";
  if (!idaVuelta) jornada.value = "1";
});

clubLocal.addEventListener("change", actualizarSelectsClubes);

// ========== INFO PARTIDO ==========
function updateMatchInfo() {
  const localId = clubLocal.value;
  const visitanteId = clubVisitante.value;
  const matchInfo = $id("matchInfo");
  const matchInfoText = $id("matchInfoText");

  if (!localId || !visitanteId) {
    matchInfo.style.display = "none";
    return;
  }

  const localName = clubLocal.options[clubLocal.selectedIndex].text;
  const visitanteName = clubVisitante.options[clubVisitante.selectedIndex].text;

  if (localId === visitanteId) {
    matchInfo.style.display = "block";
    matchInfoText.textContent = "‚ö†Ô∏è No puedes seleccionar el mismo club para ambos equipos";
    matchInfo.classList.remove("alert-info");
    matchInfo.classList.add("alert-warning");
  } else {
    matchInfo.style.display = "block";
    matchInfoText.textContent = `Partido: ${localName} (Local) vs ${visitanteName} (Visitante)`;
    matchInfo.classList.remove("alert-warning");
    matchInfo.classList.add("alert-info");
  }
}

// ========== GUARDAR PARTIDO ==========
async function guardarPartido() {

  const torneo_id = torneo.value;
  const fase_nombre = fase.value;
  const tipo_fase = tipoFase.value;
  const categoria = document.querySelector('input[name="categoria"]:checked')?.value;
  const club_local_id = clubLocal.value;
  const club_visitante_id = clubVisitante.value;

  if (!torneo_id || !fase_nombre || !tipo_fase || !categoria || !club_local_id || !club_visitante_id) {
    Swal.fire({
      icon: "warning",
      title: "Campos incompletos",
      text: "Por favor completa todos los campos obligatorios",
      background: "#2c3e50",
      color: "#f5f6fa"
    });
    return;
  }

  if (club_local_id === club_visitante_id) {
    Swal.fire({
      icon: "error",
      title: "Error",
      text: "El club local y visitante no pueden ser el mismo",
      background: "#2c3e50",
      color: "#f5f6fa"
    });
    return;
  }

  btnGuardar.disabled = true;
  loading.style.display = "block";

  const payload = {
    torneo_id: parseInt(torneo_id),
    fase_nombre: fase_nombre,
    categoria: categoria,
    club_local_id: parseInt(club_local_id),
    club_visitante_id: parseInt(club_visitante_id),
    jornada: parseInt(jornada.value),
    ida_vuelta: tipo_fase === "1",
    fecha_partido: fechaPartido.value || null,
    hora_partido: horaPartido.value || null
  };

  try {
    const res = await fetch("/api/playoff/crear_partido", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });

    const data = await res.json();

    if (!res.ok || !data.success) {
      Swal.fire({
        icon: "error",
        title: "Error",
        text: data?.message || "No se pudo guardar el partido",
        background: "#2c3e50",
        color: "#f5f6fa"
      });
      return;
    }

    Swal.fire({
      icon: "success",
      title: "√âxito",
      text: data.message,
      background: "#2c3e50",
      color: "#f5f6fa",
      timer: 1500,
      showConfirmButton: false
    });

    // üî• SOLO LIMPIAMOS EQUIPOS Y FECHA
    clubLocal.value = "";
    clubVisitante.value = "";
    fechaPartido.value = "";
    horaPartido.value = "";
    jornada.value = "1";

    updateMatchInfo();

    // üîÑ Recargar clubes autom√°ticamente
    await cargarClubesClasificados();

  } catch (err) {
    console.error(err);
    Swal.fire({
      icon: "error",
      title: "Error de conexi√≥n",
      text: "No se pudo conectar con el servidor",
      background: "#2c3e50",
      color: "#f5f6fa"
    });
  } finally {
    btnGuardar.disabled = false;
    loading.style.display = "none";
  }
}

horaPartido.addEventListener("keypress", e => {
  if (e.key === "Enter") guardarPartido();
});
</script>

</body>
</html>