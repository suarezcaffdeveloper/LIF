<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <title>Cargar EstadÃ­sticas â€” Inferiores</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      background: linear-gradient(135deg, #1a1a2e 0%, #242440 100%);
      color: #f5f6fa;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      min-height: 100vh;
      padding-bottom: 40px;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
    }

    h1 {
      text-align: center;
      margin-top: 50px;
      margin-bottom: 60px;
      font-weight: 800;
      color: #5dade2;
      text-transform: uppercase;
      letter-spacing: 2px;
      font-size: 2.5rem;
      position: relative;
      padding-bottom: 20px;
    }

    h1::after {
      content: '';
      display: block;
      width: 80px;
      height: 3px;
      background: linear-gradient(90deg, #5dade2, #2a5f7f);
      margin: 15px auto 0;
      border-radius: 2px;
    }

    .card {
      background: linear-gradient(135deg, rgba(45, 45, 60, 0.9), rgba(60, 60, 80, 0.8));
      border: none;
      border-radius: 20px;
      box-shadow: 
        0 20px 50px rgba(0, 0, 0, 0.3),
        0 0 30px rgba(93, 173, 226, 0.1);
      color: #f5f6fa;
      padding: 35px;
      border: 1px solid rgba(93, 173, 226, 0.2);
      backdrop-filter: blur(10px);
    }

    .form-label {
      font-weight: 700;
      color: #5dade2;
      margin-top: 15px;
      margin-bottom: 8px;
      font-size: 0.95rem;
      letter-spacing: 0.3px;
    }

    select, input {
      background: linear-gradient(135deg, #2a2a3f, #3a3a50) !important;
      color: #fff !important;
      border: 1px solid rgba(93, 173, 226, 0.4) !important;
      border-radius: 10px;
      padding: 12px 15px !important;
      transition: all 0.3s ease !important;
      font-weight: 500 !important;
    }

    select:hover, input:hover {
      border-color: rgba(93, 173, 226, 0.6) !important;
      box-shadow: 0 0 15px rgba(93, 173, 226, 0.1) !important;
    }

    select:focus, input:focus {
      background: linear-gradient(135deg, #3a3a50, #4a4a65) !important;
      border-color: #5dade2 !important;
      box-shadow: 0 0 20px rgba(93, 173, 226, 0.2) !important;
      outline: none !important;
    }

    select option {
      background: linear-gradient(135deg, #2a2a3f, #3a3a50);
      color: #ffffff;
      padding: 10px 15px;
      font-weight: 500;
    }

    select option:checked {
      background: linear-gradient(135deg, #5dade2, #4a96c7);
      color: #ffffff;
    }

    .btn-primary {
      background: linear-gradient(135deg, #5dade2, #4a96c7);
      border-color: #5dade2;
      border: none;
      font-weight: 700;
      border-radius: 10px;
      padding: 10px 16px;
      transition: all 0.3s ease;
    }

    .btn-primary:hover {
      background: linear-gradient(135deg, #4a96c7, #3d7da8);
      box-shadow: 0 10px 25px rgba(93, 173, 226, 0.3);
      transform: translateY(-2px);
    }

    .btn-add-item {
      background: #2a5f7f !important;
      border: 1px solid #5dade2 !important;
      color: #5dade2 !important;
      transition: 0.2s;
      border-radius: 8px;
    }

    .btn-add-item:hover {
      background: #5dade2 !important;
      color: #1f1f1f !important;
    }

    .subtitulo {
      color: #5dade2;
      font-size: 1.3rem;
      font-weight: 700;
      margin: 30px 0 20px 0;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .side-box {
      border-radius: 16px;
      padding: 20px;
      background: rgba(93, 173, 226, 0.05);
      border-left: 3px solid #5dade2;
      border: 1px solid rgba(93, 173, 226, 0.2);
      margin-bottom: 15px;
      transition: all 0.3s ease;
    }

    .side-box:hover {
      background: rgba(93, 173, 226, 0.08);
      border-color: rgba(93, 173, 226, 0.4);
    }

    .side-box h5 {
      font-weight: 700;
      color: #5dade2;
      margin-bottom: 15px;
      font-size: 1.1em;
    }

    .list-row {
      margin-bottom: 10px;
      padding: 12px;
      display: grid;
      grid-template-columns: 1fr auto auto;
      gap: 12px;
      align-items: center;
      background: rgba(0, 0, 0, 0.3);
      border-radius: 8px;
      border-left: 3px solid #5dade2;
    }

    .list-row select {
      width: 100%;
    }

    .list-row input {
      width: 100%;
    }

    .remove-row {
      background: transparent;
      border: 1px solid #aa3333;
      color: #ffaaaa;
      border-radius: 6px;
      padding: 6px 12px;
      cursor: pointer;
      transition: 0.2s;
    }

    .remove-row:hover {
      background: #aa3333;
      color: #fff;
    }

    .small-input { width: 100%; }
    .muted { color: #bfc9d9; font-size: 0.9rem; }

    /* Responsive */
    @media (max-width: 768px) {
      body {
        padding: 20px 15px;
      }

      h1 {
        font-size: 1.8rem;
        margin-top: 30px;
        margin-bottom: 40px;
      }

      .card {
        padding: 25px;
      }

      .list-row {
        grid-template-columns: 1fr;
        gap: 8px;
      }
    }
  </style>
</head>

<body>

<div class="container">
  <h1>ðŸ“š Cargar EstadÃ­sticas â€” Inferiores</h1>

  <!-- FLASH MESSAGES -->
  <div class="container mt-3" id="flash-container">
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        {% for category, message in messages %}
          <div class="alert alert-{{ 
            'success' if category=='success' else 
            'danger' if category=='error' else 
            'warning' if category=='warning' else 
            'info' }}" 
            role="alert"
            style="border-radius: 12px; box-shadow: 0 8px 24px rgba(0,0,0,0.3); border: 1px solid rgba(93, 173, 226, 0.2); backdrop-filter: blur(10px);">

            <div class="d-flex justify-content-between align-items-center">
              <span>{{ message }}</span>
              <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>

          </div>
        {% endfor %}
      {% endif %}
    {% endwith %}
  </div>

  <div class="card">

    <!-- JORNADAS -->
    <div class="mb-3">
      <label class="form-label">Seleccionar Jornada</label>
      <select id="select-jornada" class="form-select">
        <option value="">Seleccionar...</option>
        {% for j in jornadas %}
          <option value=" {{ j }}">Jornada {{ j }}</option>
        {% endfor %}
      </select>
    </div>

    <!-- PARTIDOS -->
    <div id="partidos-container" style="display:none;">
      <div class="mb-3">
        <label class="form-label">Cruces de la Jornada</label>
        <select id="select-partido" class="form-select">
          <option value="">Seleccione un cruce...</option>
        </select>
      </div>
    </div>

    <hr>

    <!-- FORMULARIOS -->
    <div id="formularios-estadisticas" style="display:none;">

      <!-- BLOQUE plantilla para cada categorÃ­a (se repite 3 veces con ids) -->
      <!-- QUINTA -->
      <div id="bloque-quinta" style="display:none;">
        <h3 class="subtitulo">Quinta DivisiÃ³n</h3>

        <div class="row" style="margin:0;">
          <!-- LOCAL -->
          <div class="col-md-6" style="padding:10px;">
            <div class="side-box">
              <h5 id="quinta_local_nombre">Local</h5>

              <label class="form-label">Goles</label>
              <input type="number" id="quinta_goles_local" class="form-control" min="0" value="0">

              <label class="form-label">Goleadores</label>
              <div id="quinta_goleadores_local_list"></div>
              <button class="btn btn-sm btn-add-item w-100" onclick="addGoleador('quinta','local')">+ Agregar Goleador</button>

              <label class="form-label">Tarjetas Disciplinarias</label>
              <div id="quinta_tarjetas_local_list"></div>
              <button class="btn btn-sm btn-add-item w-100" onclick="addTarjeta('quinta','local')">+ Agregar Tarjeta</button>
            </div>
          </div>

          <!-- VISITANTE -->
          <div class="col-md-6" style="padding:10px;">
            <div class="side-box">
              <h5 id="quinta_visitante_nombre">Visitante</h5>

              <label class="form-label">Goles</label>
              <input type="number" id="quinta_goles_visitante" class="form-control" min="0" value="0">

              <label class="form-label">Goleadores</label>
              <div id="quinta_goleadores_visitante_list"></div>
              <button class="btn btn-sm btn-add-item w-100" onclick="addGoleador('quinta','visitante')">+ Agregar Goleador</button>

              <label class="form-label">Tarjetas Disciplinarias</label>
              <div id="quinta_tarjetas_visitante_list"></div>
              <button class="btn btn-sm btn-add-item w-100" onclick="addTarjeta('quinta','visitante')">+ Agregar Tarjeta</button>
            </div>
          </div>
        </div>

        <button id="btn_guardar_quinta" class="btn btn-primary w-100 mt-4" onclick="guardarCategoria('quinta')">Guardar Quinta</button>
      </div>

      <!-- SEXTA -->
      <div id="bloque-sexta" style="display:none;">
        <h3 class="subtitulo">Sexta DivisiÃ³n</h3>

        <div class="row" style="margin:0;">
          <!-- LOCAL -->
          <div class="col-md-6" style="padding:10px;">
            <div class="side-box">
              <h5 id="sexta_local_nombre">Local</h5>

              <label class="form-label">Goles</label>
              <input type="number" id="sexta_goles_local" class="form-control" min="0" value="0">

              <label class="form-label">Goleadores</label>
              <div id="sexta_goleadores_local_list"></div>
              <button class="btn btn-sm btn-add-item w-100" onclick="addGoleador('sexta','local')">+ Agregar Goleador</button>

              <label class="form-label">Tarjetas Disciplinarias</label>
              <div id="sexta_tarjetas_local_list"></div>
              <button class="btn btn-sm btn-add-item w-100" onclick="addTarjeta('sexta','local')">+ Agregar Tarjeta</button>
            </div>
          </div>

          <!-- VISITANTE -->
          <div class="col-md-6" style="padding:10px;">
            <div class="side-box">
              <h5 id="sexta_visitante_nombre">Visitante</h5>

              <label class="form-label">Goles</label>
              <input type="number" id="sexta_goles_visitante" class="form-control" min="0" value="0">

              <label class="form-label">Goleadores</label>
              <div id="sexta_goleadores_visitante_list"></div>
              <button class="btn btn-sm btn-add-item w-100" onclick="addGoleador('sexta','visitante')">+ Agregar Goleador</button>

              <label class="form-label">Tarjetas Disciplinarias</label>
              <div id="sexta_tarjetas_visitante_list"></div>
              <button class="btn btn-sm btn-add-item w-100" onclick="addTarjeta('sexta','visitante')">+ Agregar Tarjeta</button>
            </div>
          </div>
        </div>

        <button id="btn_guardar_sexta" class="btn btn-primary w-100 mt-4" onclick="guardarCategoria('sexta')">Guardar Sexta</button>
      </div>

      <!-- SEPTIMA -->
      <div id="bloque-septima" style="display:none;">
        <h3 class="subtitulo">SÃ©ptima DivisiÃ³n</h3>

        <div class="row" style="margin:0;">
          <!-- LOCAL -->
          <div class="col-md-6" style="padding:10px;">
            <div class="side-box">
              <h5 id="septima_local_nombre">Local</h5>

              <label class="form-label">Goles</label>
              <input type="number" id="septima_goles_local" class="form-control" min="0" value="0">

              <label class="form-label">Goleadores</label>
              <div id="septima_goleadores_local_list"></div>
              <button class="btn btn-sm btn-add-item w-100" onclick="addGoleador('septima','local')">+ Agregar Goleador</button>

              <label class="form-label">Tarjetas Disciplinarias</label>
              <div id="septima_tarjetas_local_list"></div>
              <button class="btn btn-sm btn-add-item w-100" onclick="addTarjeta('septima','local')">+ Agregar Tarjeta</button>
            </div>
          </div>

          <!-- VISITANTE -->
          <div class="col-md-6" style="padding:10px;">
            <div class="side-box">
              <h5 id="septima_visitante_nombre">Visitante</h5>

              <label class="form-label">Goles</label>
              <input type="number" id="septima_goles_visitante" class="form-control" min="0" value="0">

              <label class="form-label">Goleadores</label>
              <div id="septima_goleadores_visitante_list"></div>
              <button class="btn btn-sm btn-add-item w-100" onclick="addGoleador('septima','visitante')">+ Agregar Goleador</button>

              <label class="form-label">Tarjetas Disciplinarias</label>
              <div id="septima_tarjetas_visitante_list"></div>
              <button class="btn btn-sm btn-add-item w-100" onclick="addTarjeta('septima','visitante')">+ Agregar Tarjeta</button>
            </div>
          </div>
        </div>

        <button id="btn_guardar_septima" class="btn btn-primary w-100 mt-4" onclick="guardarCategoria('septima')">Guardar SÃ©ptima</button>
      </div>

    </div>

  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
/* ====================================================
   Estado global y utilidades
   ==================================================== */
const CATS = ["quinta","sexta","septima"];
const estadoCruces = {};

let current = {
  jornada: null,
  local_club_id: null,
  visitante_club_id: null,
  equipos_por_categoria: {},

  jugadores_quinta_local: [],
  jugadores_quinta_visitante: [],
  jugadores_sexta_local: [],
  jugadores_sexta_visitante: [],
  jugadores_septima_local: [],
  jugadores_septima_visitante: [],

  id_quinta: null,
  id_sexta: null,
  id_septima: null,
};

function $id(id){ return document.getElementById(id); }

function safeParseInt(v, fallback=0){
  const n = parseInt(v);
  return Number.isFinite(n) ? n : fallback;
}

function disableButtonAfterSubmit(btnId){
  const btn = $id(btnId);
  if(!btn) return;
  btn.disabled = true;
  btn.classList.remove("btn-primary");
  btn.classList.add("btn-success");
  btn.textContent = "Guardado âœ”";
}

function limpiarFormularioCategoria(cat){
  $id(`${cat}_goles_local`).value = 0;
  $id(`${cat}_goles_visitante`).value = 0;

  [
    `${cat}_goleadores_local_list`,
    `${cat}_goleadores_visitante_list`,
    `${cat}_tarjetas_local_list`,
    `${cat}_tarjetas_visitante_list`
  ].forEach(id => { const el = $id(id); if(el) el.innerHTML = ""; });
}

function buildPlayerOptions(players){
  if(!Array.isArray(players) || players.length===0) return `<option value="">-- Sin jugadores --</option>`;
  return players.map(p => `<option value="${p.id}">${escapeHtml(p.nombre)}</option>`).join("");
}

/* small helper to avoid XSS if alguna vez usÃ¡s nombres con chars raros */
function escapeHtml(str){
  return String(str)
    .replace(/&/g, "&amp;")
    .replace(/</g, "&lt;")
    .replace(/>/g, "&gt;")
    .replace(/"/g, "&quot;")
    .replace(/'/g, "&#039;");
}

/* ====================================================
   ValidaciÃ³n goles vs goleadores
   ==================================================== */
function validarGolesVsGoleadores(cat){
  const golesLocal = safeParseInt($id(`${cat}_goles_local`).value, 0);
  const golesVisitante = safeParseInt($id(`${cat}_goles_visitante`).value, 0);

  const sumLocal = [...document.querySelectorAll(`#${cat}_goleadores_local_list [data-goles]`)]
    .reduce((a,b) => a + safeParseInt(b.value,0), 0);

  const sumVisitante = [...document.querySelectorAll(`#${cat}_goleadores_visitante_list [data-goles]`)]
    .reduce((a,b) => a + safeParseInt(b.value,0), 0);

  if (sumLocal !== golesLocal) {
    Swal.fire("Inconsistencia", `El total de goles locales (${sumLocal}) no coincide con el resultado (${golesLocal})`, "warning");
    return false;
  }
  if (sumVisitante !== golesVisitante) {
    Swal.fire("Inconsistencia", `El total de goles visitantes (${sumVisitante}) no coincide con el resultado (${golesVisitante})`, "warning");
    return false;
  } 
  return true;
}

function validarGoleadores(cat) {
  const bloques = [
    { list: `${cat}_goleadores_local_list`, equipo: "local" },
    { list: `${cat}_goleadores_visitante_list`, equipo: "visitante" }
  ];

  for (const bloque of bloques) {
    const selects = document.querySelectorAll(
      `#${bloque.list} select[data-player]`
    );

    for (const select of selects) {
      if (!select.value) {
        Swal.fire(
          "Inconsistencia",
          `Hay un goleador ${bloque.equipo} sin jugador seleccionado`,
          "warning"
        );
        return false;
      }
    }
  }
  return true;
}


/* ====================================================
   ValidaciÃ³n tarjetas vs jugadores
   ==================================================== */
function validarTarjetasVsJugadores(cat) {
  const tarjetasAmarillasLocal = [...document.querySelectorAll(`#${cat}_tarjetas_local_list select`)];
  const tarjetasRojasLocal = [...document.querySelectorAll(`#${cat}_tarjetas_local_list select`)];
  const tarjetasAmarillasVisitante = [...document.querySelectorAll(`#${cat}_tarjetas_visitante_list select`)];
  const tarjetasRojasVisitante = [...document.querySelectorAll(`#${cat}_tarjetas_visitante_list select`)];

  // Verificar si algÃºn jugador seleccionado es el placeholder (jugador sin ID)
  const verificarTarjeta = (tarjetas, equipo) => {
    for (let tarjeta of tarjetas) {
      if (tarjeta.value === "" || tarjeta.value === "jugador") {
        Swal.fire("Inconsistencia", `El jugador seleccionado para las tarjetas de ${equipo} no es vÃ¡lido. Por favor, selecciona un jugador real.`, "warning");
        return false;
      }
    }
    return true;
  };

  // Validar tarjetas locales y visitantes
  if (!verificarTarjeta(tarjetasAmarillasLocal, "local") || 
      !verificarTarjeta(tarjetasRojasLocal, "local") ||
      !verificarTarjeta(tarjetasAmarillasVisitante, "visitante") ||
      !verificarTarjeta(tarjetasRojasVisitante, "visitante")) {
    return false;
  }

  return true;
}

/* ====================================================
   Eventos: selecciÃ³n de jornada -> cruces
   ==================================================== */
/* ================================
   SELECT JORNADA â†’ CARGA CRUCES
================================ */
const selectJornada = $id("select-jornada");
const selectPartido = $id("select-partido");

if (selectJornada) {
  selectJornada.addEventListener("change", async function () {
    const id_jornada = this.value;
    current.jornada = id_jornada || null;

    resetAfterJornada();

    if (!id_jornada) return;

    await cargarCrucesPendientes(id_jornada);

    $id("partidos-container").style.display = "block";
  });
}



/* ================================
   CARGAR SOLO CRUCES PENDIENTES
================================ */
async function cargarCrucesPendientes(id_jornada) {
    try {
        id_jornada = String(id_jornada).trim(); 
        const torneo = "Apertura"; // ahora siempre lo enviamos

        const r = await fetch(`/api/cruces_pendientes/${id_jornada}?torneo=${torneo}`);
        console.log("ðŸ“¡ Status HTTP:", r.status);

        if (!r.ok) throw new Error(`Error HTTP ${r.status}`);

        const data = await r.json();
        console.log("ðŸ“¦ Respuesta JSON:", data);

        // Reset del select
        selectPartido.innerHTML = `<option value="">Seleccionar cruce...</option>`;

        if (!Array.isArray(data) || data.length === 0) {
            Swal.fire("InformaciÃ³n", "Todos los partidos de esta jornada ya fueron cargados", "info");
            return;
        }

        // Cargar opciones
        data.forEach(c => {
            const opt = document.createElement("option");
            opt.value = c.id;
            opt.textContent = c.texto;
            selectPartido.appendChild(opt);
        });

        console.log("âœ… Cruces cargados en el select");

    } catch (e) {
        console.error("âŒ ERROR DETALLADO:", e);
        Swal.fire("Error", "No se pudieron cargar los cruces pendientes", "error");
    }
}

/* ==========================================
   SELECT CRUCE â†’ CARGA PARTIDOS + JUGADORES
========================================== */
if (selectPartido) {
  selectPartido.addEventListener("change", async function () {
    const partidoId = this.value;
    resetAfterCruce();

    if (!partidoId) return;

    if (!estadoCruces[partidoId]) {
      estadoCruces[partidoId] = {
        quinta: false,
        sexta: false,
        septima: false
      };
    }

    try {
      // 1ï¸âƒ£ INFO GENERAL DEL CRUCE
      const infoResp = await fetch(`/api/info_cruce_inferiores/${partidoId}`);
      if (!infoResp.ok) throw new Error("Error info cruce");

      const info = await infoResp.json();

      current.local_club_id = info.local_id;
      current.visitante_club_id = info.visitante_id;

      CATS.forEach(cat => {
        $id(`${cat}_local_nombre`).innerText = info.local_nombre;
        $id(`${cat}_visitante_nombre`).innerText = info.visitante_nombre;
      });


      // 2ï¸âƒ£ PARTIDOS DEL CRUCE
      const cruceResp = await fetch("/get_partidos_cruce_inferiores", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          jornada: current.jornada,
          local: current.local_club_id,
          visitante: current.visitante_club_id
        })
      });

      if (!cruceResp.ok) throw new Error("Error partidos cruce");

      const cruceData = await cruceResp.json();

      CATS.forEach(cat => {
        const key = cat === "quinta" ? "Quinta" : cat === "sexta" ? "Sexta" : "Septima";
        const d = cruceData[key] || null;

        if (d) {
          current[`id_${cat}`] = d.partido_id;
          current.equipos_por_categoria[cat] = {
            local: d.id_equipo_local,
            visitante: d.id_equipo_visitante
          };
        } else {
          current[`id_${cat}`] = null;
          current.equipos_por_categoria[cat] = null;
        }
      });

      // ðŸ§  Inicializar estado del cruce SOLO con categorÃ­as existentes
      estadoCruces[partidoId] = {};

      CATS.forEach(cat => {
        if (current[`id_${cat}`]) {
          estadoCruces[partidoId][cat] = false;
        }
      });


      // 3ï¸âƒ£ JUGADORES POR EQUIPO
      async function cargarJugadores(cat, ids) {
        if (!ids?.local || !ids?.visitante) return;

        const [locales, visitantes] = await Promise.all([
          fetch(`/api/jugadores_por_equipo/${ids.local}`).then(r => r.json()),
          fetch(`/api/jugadores_por_equipo/${ids.visitante}`).then(r => r.json())
        ]);

        current[`jugadores_${cat}_local`] = locales;
        current[`jugadores_${cat}_visitante`] = visitantes;
      }

      await Promise.all(CATS.map(cat => cargarJugadores(cat, current.equipos_por_categoria[cat])));


      // 4ï¸âƒ£ MOSTRAR SOLO BLOQUES EXISTENTES
      CATS.forEach(cat => {
        limpiarFormularioCategoria(cat);
        const bloque = $id(`bloque-${cat}`);
        if (current[`id_${cat}`]) {
          bloque.style.display = "block";
        } else {
          bloque.style.display = "none";
        }
      });

      $id("formularios-estadisticas").style.display = "block";

    } catch (err) {
      console.error("Error cargando datos del cruce:", err);
      Swal.fire("Error", "No se pudieron cargar los datos del cruce.", "error");
    }
  });
}


/* ====================================================
   DinÃ¡micos: agregar goleadores y tarjetas
   ==================================================== */
function addGoleador(cat, side){
  const cont = $id(`${cat}_goleadores_${side}_list`);
  if(!cont) return;

  const players = current[`jugadores_${cat}_${side}`] ?? [];

  const row = document.createElement("div");
  row.className = "list-row";

  row.innerHTML = `
    <select class="form-select" data-player style="grid-column:1;">
      <option value="">Seleccionar Jugador</option>
      ${buildPlayerOptions(players)}
    </select>
    <input type="number" class="form-control" data-goles min="1" value="1" placeholder="Goles" style="grid-column:2; max-width:100px;">
    <button class="remove-row btn btn-sm" title="Eliminar" onclick="this.parentElement.remove()" style="grid-column:3;">âœ•</button>
  `;
  cont.appendChild(row);
}

function addTarjeta(cat, side){
  const cont = $id(`${cat}_tarjetas_${side}_list`);
  if(!cont) return;

  const players = current[`jugadores_${cat}_${side}`] ?? [];

  const row = document.createElement("div");
  row.className = `${cat}_${side}_tarjeta_item list-row`;

  row.innerHTML = `
    <select class="form-select tarjeta-player" style="grid-column:1;">
      <option value="">Seleccionar Jugador</option>
      ${buildPlayerOptions(players)}
    </select>
    <select class="form-select tarjeta-tipo" style="grid-column:2; max-width:120px;">
      <option value="amarilla">Amarilla</option>
      <option value="roja">Roja</option>
    </select>
    <button class="remove-row btn btn-sm" title="Eliminar" onclick="this.parentElement.remove()" style="grid-column:3;">âœ•</button>
  `;
  cont.appendChild(row);
}

/* ====================================================
   RecolecciÃ³n de datos para enviar
   ==================================================== */
function collectGoleadores(cat, side){
  return [...document.querySelectorAll(`#${cat}_goleadores_${side}_list .list-row`)]
    .map(r => ({
      jugador_id: safeParseInt(r.querySelector("[data-player]").value || 0, 0),
      goles: safeParseInt(r.querySelector("[data-goles]").value || 0, 0)
    }))
    .filter(x => x.jugador_id > 0 && x.goles > 0);
}

function collectTarjetasAsObj(cat, side){
  const amarillas = [], rojas = [];
  document.querySelectorAll(`.${cat}_${side}_tarjeta_item`).forEach(el => {
    const jug = safeParseInt(el.querySelector(".tarjeta-player").value || 0, 0);
    const tipo = el.querySelector(".tarjeta-tipo").value;
    if (!jug) return;
    if (tipo === "amarilla") amarillas.push(jug); else rojas.push(jug);
  });
  return { amarillas, rojas };
}

function validarTarjetasVsJugadores(cat) {

  const validar = (selector, equipo) => {
    const selects = document.querySelectorAll(selector);
    for (const s of selects) {
      if (!s.value) {
        Swal.fire(
          "Inconsistencia",
          `Hay una tarjeta ${equipo} sin jugador seleccionado`,
          "warning"
        );
        return false;
      }
    }
    return true;
  };

  if (
    !validar(`#${cat}_tarjetas_local_list .tarjeta-player`, "local") ||
    !validar(`#${cat}_tarjetas_visitante_list .tarjeta-player`, "visitante")
  ) {
    return false;
  }

  return true;
}


/* ====================================================
   ConstrucciÃ³n del payload
   ==================================================== */
function construirPayload(cat) {
  const partidMap = {
    quinta: current.id_quinta,
    sexta: current.id_sexta,
    septima: current.id_septima
  };

  const pid = partidMap[cat];
  if (!pid) {
    throw new Error("Partido inexistente para la categorÃ­a");
  }

  const goles_local = safeParseInt($id(`${cat}_goles_local`).value, 0);
  const goles_visitante = safeParseInt($id(`${cat}_goles_visitante`).value, 0);

  const tarjetasLocal = collectTarjetasAsObj(cat, "local");
  const tarjetasVisita = collectTarjetasAsObj(cat, "visitante");

  return {
    partido_id: pid,
    categoria: cat,
    goles_local,
    goles_visitante,
    goleadores_local: collectGoleadores(cat, "local"),
    goleadores_visitante: collectGoleadores(cat, "visitante"),
    amarillas_local: tarjetasLocal.amarillas,
    rojas_local: tarjetasLocal.rojas,
    amarillas_visitante: tarjetasVisita.amarillas,
    rojas_visitante: tarjetasVisita.rojas
  };
}

/* ====================================================
   Guardar categorÃ­a (se llama por cada botÃ³n)
   ==================================================== */
async function guardarCategoria(cat) {
  const cruceId = selectPartido.value;
  if (!cruceId) return;

  // ðŸš« Si ya fue guardada, no permitir
  if (estadoCruces[cruceId]?.[cat]) {
    Swal.fire("AtenciÃ³n", "Esta categorÃ­a ya fue cargada", "warning");
    return;
  }

    if (
      !validarGolesVsGoleadores(cat) ||
      !validarGoleadores(cat) ||
      !validarTarjetasVsJugadores(cat)
    ) {
      return;
    }

  const payload = construirPayload(cat);
  console.log("PAYLOAD ENVIADO =>", payload);

  try {
    const res = await fetch("/api/guardar_inferiores", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });

    const data = await res.json();

    if (!res.ok || !data.success) {
      Swal.fire("Error", data.message || "Error al guardar", "error");
      return;
    }

    // âœ… Marcar categorÃ­a como guardada
    estadoCruces[cruceId][cat] = true;

    // ðŸ”’ Bloquear botÃ³n
    $id(`btn_guardar_${cat}`).disabled = true;

    Swal.fire("Guardado", `${cat.toUpperCase()} guardada correctamente`, "success");

    // âœ… Verificar si el cruce estÃ¡ completo
    const completo = Object.values(estadoCruces[cruceId]).every(v => v);

    if (completo) {
      eliminarCruceDelSelect(cruceId);
    }

  } catch (err) {
    console.error(err);
    Swal.fire("Error", "No se pudo guardar la categorÃ­a", "error");
  }
}


function eliminarCruceDelSelect(cruceId) {
  const opt = selectPartido.querySelector(`option[value="${cruceId}"]`);
  if (opt) opt.remove();

  selectPartido.value = "";
  $id("formularios-estadisticas").style.display = "none";

  delete estadoCruces[cruceId];

  CATS.forEach(cat => {
    limpiarFormularioCategoria(cat);
    const bloque = $id(`bloque-${cat}`);
    if (bloque) bloque.style.display = "none";

    const btn = $id(`btn_guardar_${cat}`);
    if (btn) {
      btn.disabled = false;
      btn.classList.remove("btn-success");
      btn.classList.add("btn-primary");
      btn.textContent =
        cat === "quinta" ? "Guardar Quinta" :
        cat === "sexta"  ? "Guardar Sexta"  :
                           "Guardar SÃ©ptima";
    }
  });

  Swal.fire({
    icon: "success",
    title: "Cruce completo",
    text: "Todos los partidos disponibles fueron cargados",
    timer: 1400,
    showConfirmButton: false
  });

  if (selectPartido.options.length === 1) {
    Swal.fire(
      "Jornada completa",
      "No quedan cruces pendientes para esta jornada",
      "info"
    );
  }
}


/* ====================================================
   Helpers para reset visual/estado
   ==================================================== */
function resetAfterJornada(){
  $id("partidos-container").style.display = "none";
  $id("select-partido").innerHTML = `<option value="">Seleccione un cruce...</option>`;
  resetAfterCruce();
}

function resetAfterCruce(){
  $id("formularios-estadisticas").style.display = "none";
  CATS.forEach(cat => {
    const b = $id(`bloque-${cat}`);
    if (b) b.style.display = "none";
    limpiarFormularioCategoria(cat);
    current[`id_${cat}`] = null;
    current.equipos_por_categoria[cat] = null;
    current[`jugadores_${cat}_local`] = [];
    current[`jugadores_${cat}_visitante`] = [];
    const btn = $id(`btn_guardar_${cat}`);
    if (btn) { btn.disabled = false; btn.classList.add("btn-primary"); btn.classList.remove("btn-success"); btn.textContent = btn.id.includes("quinta") ? "Guardar Quinta" : (btn.id.includes("sexta") ? "Guardar Sexta" : "Guardar SÃ©ptima"); }
  });
}

/* ====================================================
   Autoocultar alertas iniciales
   ==================================================== */
setTimeout(() => {
  document.querySelectorAll("#flash-container .alert").forEach(a => {
    a.style.transition = "opacity 0.8s";
    a.style.opacity = "0";
    setTimeout(() => a.remove(), 800);
  });
}, 3500);
</script>

</body>
</html>
