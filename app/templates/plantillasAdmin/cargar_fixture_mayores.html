<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Cargar Fixture - Jornadas Regulares</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<style>
body {
    background-color: #1e1e2f;
    color: #fff;
    min-height: 100vh;
    font-family: 'Poppins', sans-serif;
    padding: 40px;
}
.wrapper {
    display: flex;
    justify-content: center;
    align-items: flex-start;
    gap: 40px;
    flex-wrap: wrap;
}
.container-form {
    background-color: #2a2a3d;
    padding: 40px;
    border-radius: 20px;
    width: 100%;
    max-width: 520px;
    box-shadow: 0 0 15px rgba(0,0,0,0.4);
}
.container-form h2 {
    text-align: center;
    margin-bottom: 25px;
    color: #4fc3f7;
    font-weight: 700;
}
.form-control, .form-select {
    background-color: #1e1e2f;
    border: 1px solid #4fc3f7;
    color: #fff;
}
.form-control:focus, .form-select:focus {
    border-color: #4fc3f7;
    box-shadow: 0 0 8px rgba(79,195,247,0.6);
}
.btn-primary {
    background-color: #4fc3f7 !important;
    border: none;
    font-weight: 600;
    margin-top: 20px;
}
.btn-primary:hover { background-color: #39b0e0 !important; }
.card-custom {
    background-color: #2a2a3d;
    padding: 25px;
    border-radius: 20px;
    width: 100%;
    max-width: 450px;
    box-shadow: 0 0 15px rgba(0,0,0,0.4);
}
.card-custom h5 { text-align: center; color: #4fc3f7; margin-bottom: 15px; font-weight: 700; }
#partidos-list { min-height: 400px; max-height: 400px; overflow-y: auto; padding-right: 5px; }
.cruce-card {
    background-color: #ffffff;
    border: 2px solid #4fc3f7;
    border-radius: 15px;
    padding: 10px;
    margin-bottom: 12px;
    color: #000;
    cursor: pointer;
    opacity: 0;
    transform: translateX(-12px);
    animation: slideIn 0.25s ease-out forwards;
}
@keyframes slideIn { from { opacity:0; transform:translateX(-12px);} to{opacity:1; transform:translateX(0);} }
.cruce-flex { display:flex; justify-content:center; align-items:center; gap:25px; font-weight:600; }
.cruce-team { flex:1; text-align:center; }
.cruce-vs { flex:0; font-weight:800; color:#39b0e0; }
.muted { color:#aaa; text-align:center; }
.back-link { display:block; margin-top:30px; text-align:center; color:#ccc; }
.back-link:hover { color:#4fc3f7; }
#flash-container { position: fixed; top:20px; left:50%; transform: translateX(-50%); z-index:2000; pointer-events:none; }
.flash-message { display:inline-block; padding:0.5rem 1rem; border-radius:10px; font-weight:bold; text-align:center; opacity:0; transform:translateY(-20px); transition:0.5s; margin-bottom:0.5rem; pointer-events:auto; }
.flash-success { background-color:#d4edda; color:#155724; border:1px solid #c3e6cb; }
.flash-danger { background-color:#f8d7da; color:#721c24; border:1px solid #f5c6cb; }
</style>
</head>
<body>

<div id="flash-container"></div>

<div class="wrapper">

    <!-- FORM -->
    <div class="container-form">
        <h2>Cargar Fixture - Jornadas Regulares</h2>

        <form id="form-partido">

            <!-- TEMPORADA -->
            <label class="mt-2">Temporada:</label>
            <select class="form-select" disabled>
                <option selected>{{ temporada_activa.nombre }}</option>
            </select>

            <!-- TORNEO -->
            <label class="mt-3">Torneo:</label>
            <select class="form-select" disabled>
                <option selected>Apertura (se duplica en Clausura)</option>
            </select>

            <!-- JORNADA -->
             <label class="mt-3">Jornada:</label>
            <select id="jornada" class="form-select" required>
                <option value="">Seleccionar jornada...</option>
                {% for j in range(1, total_jornadas + 1) %}
                    <option value="{{ j }}">{{ j }}</option>
                {% endfor %}
            </select>

            <!-- FECHA / HORA -->
            <label class="mt-3">Fecha (opcional):</label>
            <input type="date" id="fecha" class="form-control">
            <label class="mt-3">Hora (opcional):</label>
            <input type="time" id="hora" class="form-control">

            <!-- CLUB LOCAL / VISITANTE -->
            <label class="mt-3">Club Local:</label>
            <select id="club_local" class="form-select">
                <option value="">Seleccionar club...</option>
                {% for club in clubes %}
                    <option value="{{ club.id }}">{{ club.nombre }}</option>
                {% endfor %}
            </select>

            <label class="mt-3">Club Visitante:</label>
            <select id="club_visitante" class="form-select" required>
                <option value="">Seleccionar club...</option>
                {% for club in clubes %}
                    <option value="{{ club.id }}">{{ club.nombre }}</option>
                {% endfor %}
            </select>

            <div class="d-flex justify-content-center mt-4">
                <button type="button" id="btn-guardar" class="btn btn-primary px-4">Crear partido</button>
            </div>

        </form>

        <a href="{{ url_for('views.adminview') }}" class="back-link">← Volver al panel de administrador</a>
    </div>

    <!-- PANEL PARTIDOS -->
    <div class="card-custom">
        <h5>Partidos cargados – Jornada <span id="jornada-seleccionada">-</span></h5>
        <div id="partidos-list">
            <p class="muted">Seleccione jornada y clubes para ver partidos.</p>
        </div>
    </div>

</div>

<script>
const jornadaSelect = document.getElementById("jornada");
const localSelect = document.getElementById("club_local");
const visitanteSelect = document.getElementById("club_visitante");
const listDiv = document.getElementById("partidos-list");
const jornadaLabel = document.getElementById("jornada-seleccionada");

let ocupados = [];
let clubesOriginales = [{% for club in clubes %}{id: {{ club.id }}, nombre: "{{ club.nombre }}" }{% if not loop.last %},{% endif %}{% endfor %}];

// Reconstruir selects evitando clubes ocupados
function reconstruirSelects() {
    const localSel = parseInt(localSelect.value,10) || null;
    const visSel = parseInt(visitanteSelect.value,10) || null;

    localSelect.innerHTML = '<option value="">Seleccionar club...</option>';
    visitanteSelect.innerHTML = '<option value="">Seleccionar club...</option>';

    clubesOriginales.forEach(club => {
        if (ocupados.includes(club.id)) return;

        if (club.id !== visSel) {
            const op = document.createElement("option");
            op.value = club.id;
            op.textContent = club.nombre;
            if (club.id === localSel) op.selected = true;
            localSelect.appendChild(op);
        }

        if (club.id !== localSel) {
            const op2 = document.createElement("option");
            op2.value = club.id;
            op2.textContent = club.nombre;
            if (club.id === visSel) op2.selected = true;
            visitanteSelect.appendChild(op2);
        }
    });
}

// Mostrar partido con efecto slide
function agregarPartidoSlide(p, idx=0){
    const card = document.createElement("div");
    card.classList.add("cruce-card");
    card.style.opacity = 0;
    card.style.transform = "translateY(20px)";
    card.innerHTML = `
        <div class="cruce-flex">
            <div class="cruce-team">${p.local_club_nombre}</div>
            <div class="cruce-vs">VS</div>
            <div class="cruce-team">${p.visitante_club_nombre}</div>
        </div>`;
    listDiv.appendChild(card);
    setTimeout(() => { card.style.opacity = 1; card.style.transform = "translateY(0)"; }, idx*50);
}

// Cargar partidos según jornada
async function cargarPartidos(jornada){
    jornadaLabel.textContent = jornada || "-";
    if(!jornada){ 
        listDiv.innerHTML='<p class="muted">Seleccione jornada.</p>'; 
        ocupados = [];
        reconstruirSelects();
        return; 
    }

    try{
        const res = await fetch(`/fixture/ocupados/${jornada}`);
        const data = await res.json();

        ocupados = (data.ocupados || []).map(v => parseInt(v,10)).filter(Boolean);
        reconstruirSelects();

        const partidos = data.partidos || [];
        listDiv.innerHTML = "";
        if(!partidos.length){ 
            listDiv.innerHTML='<p class="muted">No hay partidos cargados para esta jornada.</p>'; 
            return; 
        }

        partidos.forEach((p, idx) => agregarPartidoSlide(p, idx));

    }catch(err){
        console.error(err);
        listDiv.innerHTML='<p class="text-danger">Error del servidor.</p>';
    }
}

// Guardar partido
async function guardarPartidoMayores(){
    const jornada = jornadaSelect.value;
    if(!jornada || !localSelect.value || !visitanteSelect.value){ 
        mostrarFlash("Complete todos los campos.","danger"); 
        return; 
    }

    const formData = new FormData();
    formData.append("jornada", jornada);
    formData.append("club_local", localSelect.value);
    formData.append("club_visitante", visitanteSelect.value);
    formData.append("fecha", document.getElementById("fecha").value);
    formData.append("hora", document.getElementById("hora").value);

    try{
        const res = await fetch("/guardar_partido_mayores", { method:"POST", body:formData });
        const data = await res.json();

        if(data.error){ mostrarFlash(data.error,"danger"); return; }
        mostrarFlash(data.msg || "Partido cargado.","success");

        // Volver a cargar los partidos de la jornada actual
        await cargarPartidos(jornada);

        // Scroll hacia el último partido agregado
        setTimeout(() => {
            listDiv.lastElementChild?.scrollIntoView({ behavior: "smooth", block: "end" });
        }, 200);

    }catch(err){
        console.error(err);
        mostrarFlash("Error del servidor.","danger");
    }
}

jornadaSelect.addEventListener("change", () => cargarPartidos(jornadaSelect.value));
localSelect.addEventListener("change", reconstruirSelects);
visitanteSelect.addEventListener("change", reconstruirSelects);
document.getElementById("btn-guardar").addEventListener("click", e => { e.preventDefault(); guardarPartidoMayores(); });

// Flash
function mostrarFlash(msg, tipo="success"){
    const container = document.getElementById("flash-container");
    const flash = document.createElement("div");
    flash.className = `flash-message flash-${tipo}`;
    flash.textContent = msg;
    container.appendChild(flash);
    setTimeout(() => { flash.style.opacity = 1; flash.style.transform = "translateY(0)"; }, 100);
    setTimeout(() => { flash.style.opacity = 0; flash.style.transform = "translateY(-20px)"; setTimeout(()=>flash.remove(),500); }, 3000);
}
</script>
</body>
</html>